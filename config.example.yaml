library:
  music_directory: /path/to/music
  database_path: data/metadata.db
discogs:
  token: ''
lastfm:
  api_key: ''
  username: ''
  history_days: 90
openai:
  api_key: YOUR_OPENAI_API_KEY
  model: gpt-4o-mini
plex:
  enabled: false
  base_url: http://localhost:32400
  token: ''
  music_section: Music
  verify_ssl: true
  replace_existing: true
  path_map: []
playlists:
  count: 8
  tracks_per_playlist: 30
  history_days: 14
  seed_count: 5
  similar_per_seed: 20
  name_prefix: 'Auto:'
  max_age_days: 14
  export_m3u: true
  m3u_export_path: /path/to/playlists
  cache_expiry_days: 30
  name_format: artists
  recently_played_filter:
    enabled: true
    # Recency exclusions are applied during candidate selection (pre-order) for DS pier-bridge runs.
    # Post-order filtering/shrinking is forbidden; runs fail loudly on violations.
    lookback_days: 30
    min_playcount_threshold: 0
  min_duration_minutes: 90
  min_track_duration_seconds: 46
  max_track_duration_seconds: 720
  max_tracks_per_artist: 3
  artist_window_size: 8
  max_artist_per_window: 1
  min_seed_artist_ratio: 0.125
  pipeline: ds
  ds_pipeline:
    artifact_path: data/artifacts/beat3tower_32k/data_matrices_step1.npz
    mode: dynamic
    random_seed: 0
    enable_logging: true

    # Sonic feature weighting for candidate selection (must sum to 1.0)
    # rhythm: tempo/beat patterns | timbre: texture/tone | harmony: key/chords
    tower_weights:
      rhythm: 0.20      # Weight for rhythm features (0.0-1.0)
      timbre: 0.50      # Weight for timbre features (0.0-1.0)
      harmony: 0.30     # Weight for harmony features (0.0-1.0)

    # Transition weighting for end-of-track-A to start-of-track-B matching
    # Higher rhythm weight helps maintain tempo/BPM flow between tracks
    transition_weights:
      rhythm: 0.40      # Weight for rhythm features (0.0-1.0)
      timbre: 0.35      # Weight for timbre features (0.0-1.0)
      harmony: 0.25     # Weight for harmony features (0.0-1.0)

    # PCA dimensions per tower (lower = faster but less detail)
    # Max dims: rhythm=21, timbre=83, harmony=33
    tower_pca_dims:
      rhythm: 8         # PCA components for rhythm (1-21)
      timbre: 16        # PCA components for timbre (1-83)
      harmony: 8        # PCA components for harmony (1-33)

    # Hybrid embedding configuration (sonic + genre features combined)
    embedding:
      sonic_components: 32    # PCA dims for sonic features (8-64)
      genre_components: 32    # PCA dims for genre features (8-64)
      sonic_weight: 0.60      # Weight for sonic similarity (0.0-1.0)
      genre_weight: 0.40      # Weight for genre similarity (0.0-1.0)

    # Candidate pool configuration (tracks considered before construction)
    candidate_pool:
      similarity_floor: 0.20  # Min hybrid similarity to seed track (0.0-1.0)
      # Mode-specific sonic floors (hard gate before genre/hybrid):
      min_sonic_similarity_narrow: 0.10
      min_sonic_similarity_dynamic: 0.00
      # fallback if mode-specific not set:
      # min_sonic_similarity: 0.00
      max_pool_size: 1200     # Max candidates before construction phase
      max_artist_fraction: 0.125  # Max tracks from one artist as fraction of playlist
      broad_filters: ["rock", "indie", "alternative", "pop"]  # Tags ignored for narrow-mode genre gating/sim

    # Artist style-aware pier-bridge (applies to --artist playlists)
    artist_style:
      enabled: false           # Enable style-aware pier-bridge for artist playlists
      cluster_k_min: 3
      cluster_k_max: 6
      cluster_k_heuristic_enabled: true
      piers_per_cluster: 1
      per_cluster_candidate_pool_size: 400
      pool_balance_mode: equal  # equal | proportional_capped
      internal_connector_priority: true
      internal_connector_max_per_segment: 2
      bridge_floor:
        narrow: 0.08
        dynamic: 0.03
      bridge_score_weights:
        dynamic:
          bridge: 0.6
          transition: 0.4
        narrow:
          bridge: 0.7
          transition: 0.3
      genre_tiebreak_weight: 0.05

    # Construction scoring weights
    # score = alpha*seed_sim + beta*transition_sim + gamma*diversity - penalty
    scoring:
      alpha: 0.55             # Seed similarity weight (0.0-1.0)
      beta: 0.55              # Transition similarity weight (0.0-1.0)
      gamma: 0.04             # Artist diversity bonus (0.0-0.2)
      # Alpha schedule: "constant" uses alpha throughout, "arc" varies by position
      alpha_schedule: arc     # "constant" or "arc"
      alpha_start: 0.65       # Alpha at playlist start (if arc)
      alpha_mid: 0.45         # Alpha at midpoint (if arc)
      alpha_end: 0.60         # Alpha at playlist end (if arc)
      arc_midpoint: 0.55      # Where midpoint falls in playlist (0.0-1.0)

    # Constraint configuration
    constraints:
      min_gap: 6              # Min positions between same artist
      hard_floor: true        # Reject (true) vs penalize (false) below floor
      # Per-mode transition floors (higher = fewer "teleports")
      transition_floor_dynamic: 0.35
      transition_floor_narrow: 0.45
      # transition_floor: 0.35  # Optional global override for all modes
      center_transitions: true # Center X_start/X_end matrices for scoring

    # Pier-bridge ordering/scoring (applies to all playlists when pipeline=ds)
    pier_bridge:
      # Bridge-local gate: require min(sim_to_pier_A, sim_to_pier_B) >= floor
      bridge_floor_dynamic: 0.03
      bridge_floor_narrow: 0.08
      # Edge scoring weights (bridge harmonic mean vs local transition)
      weight_bridge_dynamic: 0.6
      weight_transition_dynamic: 0.4
      weight_bridge_narrow: 0.7
      weight_transition_narrow: 0.3
      # Small genre tie-breaker (never rescues hard gates)
      genre_tiebreak_weight: 0.05
      # Soft genre whiplash penalty (does NOT gate): if edge_genre < threshold,
      # final_edge_score *= (1 - strength)
      soft_genre_penalty_threshold: 0.20
      soft_genre_penalty_strength: 0.10
      # Segment-local candidate pool strategy (recommended).
      # "segment_scored" builds a per-segment pool by scoring candidates jointly vs BOTH
      # endpoints (pier A and pier B), rather than unioning neighbor lists.
      segment_pool_strategy: segment_scored
      segment_pool_max: 400
      max_segment_pool_max: 1200

      # Progress constraint (A→B) to reduce "teleporting" / bouncing during bridges.
      # Uses projection onto the AB direction in the sonic similarity space.
      progress:
        enabled: true
        monotonic_epsilon: 0.05
        penalty_weight: 0.15

      # Duration penalty (geometric): penalizes bridge candidates based on percentage excess
      # over pier tracks. Uses a three-phase curve that accelerates from gentle to severe.
      # Does NOT block long tracks (hard filter does that), but reduces score based on
      # how much longer they are than the pier tracks.
      #
      # Three-phase geometric curve (percentage-based):
      #   0-20% excess:   Gentle penalties (barely noticeable)
      #   20-50% excess:  Moderate penalties (increasing)
      #   50-100% excess: Steep penalties (strong discouragement)
      #   >100% excess:   Severe penalties (track is 2x+ longer than pier)
      duration_penalty:
        enabled: true                # Enable duration penalty (default: true)
        weight: 0.30                 # Penalty strength (default: 0.30, range: 0.10-0.50)
        # Example: 200s pier track → 400s candidate (+100%) = severe penalty ≈ 0.75

      # Interior artist policies (optional):
      # - For `--artist` playlists, the seed artist is DISALLOWED in bridge interiors by default (piers-only).
      # - To override in any run, you can set:
      #   disallow_seed_artist_in_interiors: false   # allow seed artist inside segments
      #   disallow_pier_artists_in_interiors: true   # disallow endpoint artists inside segments

      # Optional: segment infeasibility handling (default OFF).
      # If a segment is infeasible under the current bridge_floor + allowed pool,
      # this can retry the SAME segment with a lower bridge_floor.
      infeasible_handling:
        enabled: false
        strategy: "backoff"
        min_bridge_floor: 0.00
        backoff_steps: [0.08, 0.06, 0.05, 0.04, 0.03, 0.02, 0.01, 0.00]
        max_attempts_per_segment: 8
        widen_search_on_backoff: true
        # Widening knobs applied only after the first failure:
        extra_neighbors_m: 200
        extra_bridge_helpers: 100
        extra_beam_width: 50
        extra_expansion_attempts: 2

      # Optional: write a markdown run audit report (default OFF).
      # Useful when debugging infeasible segments or verifying gating behavior.
      audit_run:
        enabled: false
        out_dir: "docs/run_audits"
        include_top_k: 25
        max_bytes: 350000
        write_on_success: true
        write_on_failure: true

    # Repair pass configuration (fixes weak transitions after construction)
    repair:
      enabled: true           # Enable post-construction repair pass      
      max_iters: 5            # Max repair iterations
      max_edges: 5            # Max edges to fix per iteration
      objective: gap_penalty  # "gap_penalty" or "below_floor_first"
  sonic:
    sim_variant: tower_pca
  genre_similarity:
    enabled: true
    weight: 0.50
    sonic_weight: 0.50
    min_genre_similarity: 0.35
    min_genre_similarity_narrow: 0.60
    method: ensemble
    similarity_file: data/genre_similarity.yaml
    use_artist_tags: true
    broad_filters:
    - 50s
    - 60s
    - 70s
    - 80s
    - 90s
    - 00s
    - 10s
    - '1950'
    - '1960'
    - '1970'
    - '1980'
    - '1990'
    - '2000'
    - '2010'
    - '2020'
    - 2000s
    - 2010s
    - 2020s
    - rock
    - pop
    - indie
    - alternative
    - experimental
    - instrumental
    - ambient
    - electronic
    - underground
    - classic
    - modern
    - contemporary
    - male vocalists
    - female vocalists
    - male vocalist
    - female vocalist
    - british
    - american
    - canadian
    - english
    - uk
    - usa
    - nyc
    - london
    - lo-fi
    - lofi
    - chillout
    - chill
    - beautiful
    - melancholy
    - sad
    - happy
    - love
    - mellow
    - catchy
    - awesome
    - cool
    - good
    - great
    - seen live
    - favorites
    - favourite
    - my music
    - owned
    - liked
    - to buy
    - unknown
    - various
    - other
    - misc
    - soundtrack
    - ost
    - cover
    - covers
    - remix
    - remixes
    - live
    - bootleg
    - demo
    - reissue
    - compilation
  similarity:
    min_threshold: 0.5
    artist_direct_match: 0.9
    artist_shared_base: 0.4
    artist_shared_increment: 0.05
    artist_shared_max: 0.7
  limits:
    similar_tracks: 50
    similar_artists: 30
    extension_base: 10
    extension_increment: 20
  duration_match:
    enabled: true
    weight: 0.35
    window_frac: 0.25
    falloff: 0.6
    min_target_seconds: 40
  dedupe:
    title:
      enabled: true
      threshold: 92
      mode: loose
      short_title_min_len: 6
logging:
  level: DEBUG
  file: logs/playlist_generator.log
